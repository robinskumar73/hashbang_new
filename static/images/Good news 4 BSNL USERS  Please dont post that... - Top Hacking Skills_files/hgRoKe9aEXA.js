/*!CK:3539579323!*//*1406772597,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["kJPvY"]); }

__d("MercuryActionStatus",[],function(a,b,c,d,e,f){e.exports={UNSENT:0,SUCCESS:1,UNCONFIRMED:3,FAILED_UNKNOWN_REASON:4,UNABLE_TO_CONFIRM:5,RESENT:6,RESENDING:7,ERROR:10};},null);
__d("MercuryActionTypeConstants",[],function(a,b,c,d,e,f){e.exports={LOG_MESSAGE:"ma-type:log-message",USER_GENERATED_MESSAGE:"ma-type:user-generated-message",CHANGE_READ_STATUS:"ma-type:change_read_status",CHANGE_MUTE_SETTINGS:"ma-type:change-mute-settings",CLEAR_CHAT:"ma-type:clear_chat",SEND_MESSAGE:"ma-type:send-message",UPDATE_ACTION_ID:"ma-type:update-action-id",DELETE_MESSAGES:"ma-type:delete-messages",DELETE_THREAD:"ma-type:delete-thread",CHANGE_ARCHIVED_STATUS:"ma-type:change-archived-status",CHANGE_FOLDER:"ma-type:change-folder"};},null);
__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){e.exports={CHAT:"chat",JEWEL:"jewel",MERCURY:"mercury",WEBMESSENGER:"web_messenger"};},null);
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){e.exports={PHOTO:"attach:image",VIDEO:"attach:video",MUSIC:"attach:music",VOICE:"attach:voice",TEXT:"attach:text",MSWORD:"attach:ms:word",MSXLS:"attach:ms:xls",MSPPT:"attach:ms:ppt",UNKNOWN:"attach:unknown"};},null);
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){e.exports={ERROR:"error",FILE:"file",PHOTO:"photo",STICKER:"sticker",SHARE:"share",VIDEO:"video"};},null);
__d("MercuryErrorType",[],function(a,b,c,d,e,f){e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};},null);
__d("MercuryGenericConstants",[],function(a,b,c,d,e,f){e.exports={PENDING_THREAD_ID:"pending:pending",MAX_THREAD_NAME_LENGTH:"250"};},null);
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};},null);
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){e.exports={SUBSCRIBE:"log:subscribe",UNSUBSCRIBE:"log:unsubscribe",VIDEO_CALL:"log:video-call",PHONE_CALL:"log:phone-call",THREAD_NAME:"log:thread-name",THREAD_IMAGE:"log:thread-image",SERVER_ERROR:"log:error-msg",LIVE_LISTEN:"log:live-listen",WALLPAPER:"log:wallpaper"};},null);
__d("MercuryParticipantTypes",[],function(a,b,c,d,e,f){e.exports={USER:"user",THREAD:"thread",EVENT:"event",PAGE:"page",FRIEND:"friend"};},null);
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){e.exports={UNKNOWN:"unknown",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_CLEAR_CHAT:"client_clear_chat",CLIENT_DELETE_MESSAGES:"client_delete_messages",CLIENT_DELETE_THREAD:"client_delete_thread",CLIENT_HANDLE_ERROR:"client_handle_error",SERVER_INITIAL_DATA:"server_initial_data",SERVER_SEND_MESSAGE:"server_send_message",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_MARK_SEEN:"server_mark_seen",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",SERVER_THREAD_SYNC:"server_thread_sync",SERVER_TAB_PRESENCE:"server_tab_presence",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_SEARCH:"server_search"};},null);
__d("MercurySourceType",[],function(a,b,c,d,e,f){e.exports={CHAT_ORCA:"source:chat:orca",CHAT_IPHONE:"source:chat:iphone",CHAT_JABBER:"source:chat:jabber",CHAT_MEEBO:"source:chat:meebo",CHAT_WEB:"source:chat:web",CHAT_TEST:"source:chat:test",CHAT:"source:chat",EMAIL:"source:email",GIGABOXX_API:"source:gigaboxx:api",GIGABOXX_BLAST:"source:gigaboxx:blast",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",GIGABOXX_MOBILE:"source:gigaboxx:mobile",GIGABOXX_WAP:"source:gigaboxx:wap",GIGABOXX_WEB:"source:gigaboxx:web",LEIA:"source:leia",SHARE_DIALOG:"source:share:dialog",SEND_PLUGIN:"source:sendplugin",SMS:"source:sms",TEST:"source:test",TITAN_WAP:"source:titan:wap",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_JAPAN:"source:titan:m_japan",TITAN_M_MINI:"source:titan:m_mini",TITAN_M_TOUCH:"source:titan:m_touch",TITAN_M_APP:"source:titan:m_app",TITAN_M_TABLET:"source:titan:m_tablet",TITAN_M_ZERO:"source:titan:m_zero",TITAN_M_TALK:"source:titan:m_talk",TITAN_WEB:"source:titan:web",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",TITAN_API:"source:titan:api",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_ORCA:"source:titan:orca",TITAN_EMAIL_REPLY:"source:titan:emailreply",MOBILE:"source:mobile",UNKNOWN:"source:unknown",WEB:"source:web",HELPCENTER:"source:helpcenter",NEW_SHARE_DIALOG:"source:share:dialog:new",PAID_PROMOTION:"source:paid_promotion",BUFFY_SMS:"source:buffy:sms",WEBRTC_MOBILE:"source:webrtc:mobile"};},null);
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){e.exports={EMAIL_ORIGINATED:1,TITAN_ORIGINATED:2,OBJECT_ORIGINATED:3};},null);
__d("MessagingTag",[],function(a,b,c,d,e,f){e.exports={GROUPS:"groups",UNREAD:"unread",ACTION_ARCHIVED:"action:archived",INBOX:"inbox",OTHER:"other",EVENT:"event",SENT:"sent",SMS_MUTE:"sms_mute",SPAM:"spam",UPDATES:"broadcasts_inbox",BCC:"header:bcc",FILTERED_CONTENT:"filtered_content",ARCHIVED:"archived",EMAIL:"email",VOICEMAIL:"voicemail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SMS_TAG_ROOT:"SMSShortcode:",APP_ID_ROOT:"app_id:",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",MTA_SYSTEM_MESSAGE:"MTA:system_message",EMAIL_MESSAGE:"source:email"};},null);
__d("PhotoResizeModeConst",[],function(a,b,c,d,e,f){e.exports={CONTAIN:"s",COVER:"p"};},null);
__d("ReportState",["ErrorUtils","invariant"],function(a,b,c,d,e,f,g,h){var i={};function j(l,m){h(!i[l]);i[l]=m;}function k(){var l={};Object.keys(i).forEach(function(m){try{l[m]=i[m]();}catch(n){g.reportError('ReportState: callback threw an error.');}});return l;}e.exports={registerCallback:j,getState:k};},null);
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f,g){var h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;},null);
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;},null);
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f,g){var h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;},null);
__d("ImageSourceType",[],function(a,b,c,d,e,f){var g={PROFILE_PICTURE:'profile_picture',IMAGE:'image'};e.exports=g;},null);
__d("ImageSourceRequest",["CurrentUser","ImageSourceType","KeyedCallbackManager","PhotoResizeModeConst","MercuryServerDispatcher","arrayContains","extendArray"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){"use strict";this._request={fbid:null,type:null,width:null,height:null,resize_mode:null};this._callback=null;}n.prototype.setFBID=function(r){"use strict";this._request.fbid=r;return this;};n.prototype.setType=function(r){"use strict";if(!l([h.PROFILE_PICTURE,h.IMAGE],r))throw new TypeError('ImageSourceRequest.setType: invalid type '+r);this._request.type=r;return this;};n.prototype.setDimensions=function(r,s){"use strict";this._request.width=r;this._request.height=s;return this;};n.prototype.setResizeMode=function(r){"use strict";if(!l([j.COVER,j.CONTAIN],r))throw new TypeError('ImageSourceRequest.setResizeMode: invalid resize mode '+r);this._request.resize_mode=r;return this;};n.prototype.setCallback=function(r){"use strict";this._callback=r;return this;};n.prototype.send=function(){"use strict";if(!this._request.fbid||!this._request.width||!this._request.height||!this._request.type||!this._request.resize_mode||!this._callback)throw new Error('ImageSourceRequest: You must set all the fields');var r=p(),s=q(this._request);r.executeOrEnqueue(s,this._callback);if(r.getUnavailableResourcesFromRequest(s).length===1){k.trySend('/ajax/image_source.php',{requests:[this._request]});return true;}return false;};var o=null;function p(){if(o)return o;var r=new i();o=r;k.registerEndpoints({'/ajax/image_source.php':{request_user_id:g.getID(),mode:k.BATCH_DEFERRED_MULTI,batch_function:function(s,t){m(s.requests,t.requests);return s;},handler:function(s,t){var u=t.getData().requests;for(var v=0;v<u.length;++v)r.setResource(q(u[v]),s[v]);}}});return r;}function q(r){return [r.fbid,r.type,r.width,r.height,r.resize_mode].join('|');}e.exports=n;},null);
__d("MercuryIDs",[],function(a,b,c,d,e,f){var g={isValid:function(h){if(!h||typeof h!=='string')return false;return (/^\w{3,12}:/.test(h));},isValidThreadID:function(h){if(!g.isValid(h))return false;var i=g.tokenize(h);switch(i.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(h){if(!this.isValid(h))throw 'bad_id_format';var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};},getUserIDFromParticipantID:function(h){if(!g.isValid(h))return null;var i=g.tokenize(h);if(i.type!='fbid')return null;return i.value;},isMultichat:function(h){return this.isValid(h)&&this.tokenize(h).type!=='user';}};e.exports=g;},null);
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f,g){e.exports={isParticipantID:function(h){if(!g.isValid(h))throw ("bad_participant_id "+h);},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw ("bad_user_id "+h);},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw ("bad_email_id "+h);},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw ("bad_thread_id "+h);}};},null);
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f,g){var h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},maxValidSyncID:function(k,l){if(!k)return l;if(!l)return k;return l>k?l:k;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;},null);
__d("XMercurySendLogControllerURIBuilder",["XControllerURIBuilder"],function(a,b,c,d,e,f){e.exports=b('XControllerURIBuilder').create("\/messaging\/send_logger\/",{message_id:{type:"String",required:true},event:{type:"Enum",required:true},is_canonical:{type:"Bool"}});},null);
__d("MercurySendLogger",["AsyncSignal","XMercurySendLogControllerURIBuilder"],function(a,b,c,d,e,f,g,h){var i=false,j={CLIENT_SEND_ATTEMPTED:'client_send_attempted',CLIENT_RESEND_ATTEMPTED:'client_resend_attempted',CLIENT_SEND_SUCCEEDED:'client_send_succeeded',CLIENT_SEND_FAILED:'client_send_failed',CLIENT_CHANNEL_ECHO:'client_channel_echo',enable:function(){i=true;},log:function(event,k,l){if(!i)return;new g((new h()).setEnum('event',event).setString('message_id',k).setBool('is_canonical',!!l.canonical).getURI().toString()).send();}};e.exports=j;},null);
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k){var l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==undefined){var da=ba[ca];if(da!==undefined)p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==undefined)p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;},null);
__d("MercuryThreadInformer",["ArbiterMixin","copyProperties","MercuryAssert","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j){function k(m){if(!m._locked){var n=m._threadDeletions,o=m._threadChanges,p=m._threadReadChanges,q=m._threadlistChanged,r=m._unseenStateChanged,s=m._unreadStateChanged,t=m._receivedMessages,u=m._reorderedMessages,v=m._updatedMessages;m._threadDeletions={};m._threadChanges={};m._threadReadChanges={};m._threadlistChanged=false;m._unseenStateChanged=false;m._unreadStateChanged=false;m._receivedMessages={};m._reorderedMessages={};m._updatedMessages={};var w=Object.keys(o);if(w.length||q)m.inform('threadlist-updated',w);if(w.length)m.inform('threads-updated',o);for(var x in p){m.inform('thread-read-changed',p);break;}for(var x in n){m.inform('threads-deleted',n);break;}if(r)m.inform('unseen-updated',null);if(s)m.inform('unread-updated',null);for(x in t){m.inform('messages-received',t);break;}for(x in u){m.inform('messages-reordered',u);break;}for(x in v){m.inform('messages-updated',v);break;}}}function l(m){this._fbid=m;this._threadDeletions={};this._threadChanges={};this._threadReadChanges={};this._threadlistChanged=false;this._unseenStateChanged=false;this._unreadStateChanged=false;this._receivedMessages={};this._reorderedMessages={};this._updatedMessages={};this._locked=0;}h(l.prototype,g,{updatedThread:function(m){this._threadChanges[m]=true;k(this);},deletedThread:function(m){this._threadDeletions[m]=true;k(this);},updatedThreadlist:function(){this._threadlistChanged=true;k(this);},updatedUnseenState:function(){this._unseenStateChanged=true;k(this);},updatedUnreadState:function(){this._unreadStateChanged=true;k(this);},changedThreadReadState:function(m,n,o){if(!this._threadReadChanges[m]||this._threadReadChanges[m].timestamp<o)this._threadReadChanges[m]={mark_as_read:n,timestamp:o};k(this);},receivedMessage:function(m){i.isThreadID(m.thread_id);var n=m.thread_id;if(!this._receivedMessages[n])this._receivedMessages[n]=[];this._receivedMessages[n].push(m);this.updatedThread(n);},reorderedMessages:function(m,n){this._reorderedMessages[m]={source:n};k(this);},updatedMessage:function(m,n,o){if(!this._updatedMessages[m])this._updatedMessages[m]={};this._updatedMessages[m][n]={source:o};this.updatedThread(m);},synchronizeInforms:function(m){this._locked++;try{m();}catch(n){throw n;}finally{this._locked--;k(this);}},listen:function(m,n){return this.subscribe('threads-updated',function(o,p){if(p[m])n(m);});}});h(l,j);e.exports=l;},null);
__d("MercuryServerRequests",["Arbiter","ArbiterMixin","AsyncResponse","BanzaiLogger","ChannelConstants","TimestampConverter","CurrentUser","KeyedCallbackManager","LogHistory","MercuryActionStatus","MercuryActionTypeConstants","MercuryAPIArgsSource","MercuryAssert","MercuryConfig","MercuryErrorType","MercuryGenericConstants","MercuryGlobalActionType","MercuryIDs","MercuryLoggingHelper","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendLogger","MercuryServerRequestsConfig","MercurySingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercuryServerDispatcher","MercuryThreadInformer","copyProperties","createObjectFrom","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa){"use strict";var qa=o.getInstance('mercury_server'),ra=r.MERCURY;function sa(lc,mc){if(mc)lc._lastActionId=l.maxValidActionID(lc._lastActionId,mc);}function ta(lc,mc){if(mc)lc._lastActionTimestamp=Math.max(lc._lastActionTimestamp,mc);}function ua(lc,mc){var nc=mc.thread_id,oc=lc._serverToClientIDs.getResource(nc);if(!oc){if(mc.canonical_fbid){oc='user:'+mc.canonical_fbid;}else if(mc.root_message_threading_id)oc='root:'+mc.root_message_threading_id;oc=oc||'thread:'+nc;wa(lc,nc,oc);}mc.thread_id=oc;}function va(lc,mc){var nc=mc.thread_fbid;if(mc.canonical_fbid)nc=mc.canonical_fbid;var oc=lc._FBIDToClientIDs.getResource(nc);if(!oc){if(mc.canonical_fbid){oc='user:'+mc.canonical_fbid;}else if(mc.root_message_threading_id)oc='root:'+mc.root_message_threading_id;oc=oc||'thread:'+nc;if(nc)nc=nc.toString();xa(lc,nc,oc);if(mc.thread_id)wa(lc,mc.thread_id,oc);}mc.thread_id=oc;}function wa(lc,mc,nc){lc._serverToClientIDs.setResource(mc,nc);lc._clientToServerIDs.setResource(nc,mc);lc._newlyAddedClientIDs[mc]=nc;}function xa(lc,mc,nc){lc._clientIDToFBIDs.setResource(nc,mc);lc._FBIDToClientIDs.setResource(mc,nc);lc._newlyAddedClientIDs[mc]=nc;}function ya(lc,mc,nc){var oc=lc._clientToServerIDs.executeOrEnqueue(mc,nc),pc=lc._clientToServerIDs.getUnavailableResources(oc),qc=lc.tokenizeThreadID(mc);if(pc.length&&qc.type!='root')lc.fetchThreadData(pc);}function za(lc,mc,nc){var oc=lc._clientIDToFBIDs.executeOrEnqueue(mc,nc),pc=lc._clientIDToFBIDs.getUnavailableResources(oc),qc=lc.tokenizeThreadID(mc);if(pc.length&&qc.type!='root')lc.fetchThreadData(pc);}function ab(lc,mc){return lc._clientToServerIDs.getResource(mc);}function bb(lc,mc){return lc._clientIDToFBIDs.getResource(mc);}function cb(lc,mc){return !!lc._serverToClientIDs.getResource(mc);}function db(lc,mc){return !!lc._FBIDToClientIDs.getResource(mc);}function eb(lc,mc){var nc=lc._serverToClientIDs.getResource(mc);if(typeof nc=='undefined')qa.warn('no_client_thread_id',{server_id:mc});return nc;}function fb(lc,mc){var nc=lc._FBIDToClientIDs.getResource(mc);if(typeof nc=='undefined')qa.warn('no_client_thread_id',{thread_fbid:mc});return nc;}function gb(lc,mc,nc){lc._serverToClientIDs.executeOrEnqueue(mc,nc);lc.ensureThreadIsFetched(mc);}function hb(lc,mc,nc){lc._FBIDToClientIDs.executeOrEnqueue(mc,nc);lc.ensureThreadIsFetched(mc);}function ib(lc,mc,nc){if(mc.action_type!=q.SEND_MESSAGE)return;var oc=mc.client_thread_id;if(!oc)oc=eb(lc,mc.thread_id);var pc=null;if(oc)pc=x.tokenize(oc).type;lb(lc,mc,nc==='success');ja.addEntry('send_'+pc,nc,mc.thread_id+','+mc.message_id);ca.log(nc==='success'?ca.CLIENT_SEND_SUCCEEDED:ca.CLIENT_SEND_FAILED,mc.client_message_id,{canonical:pc&&!x.isMultichat(oc)});}function jb(lc,mc,nc){if(mc.action_type!=q.SEND_MESSAGE)return;var oc=mc.thread_fbid;if(mc.other_user_fbid)oc=mc.other_user_fbid;var pc=mc.client_thread_id;if(!pc)pc=fb(lc,oc);var qc=null;if(pc)qc=x.tokenize(pc).type;lb(lc,mc,nc==='success');ja.addEntry('send_'+qc,nc,oc+','+mc.message_id);ca.log(nc==='success'?ca.CLIENT_SEND_SUCCEEDED:ca.CLIENT_SEND_FAILED,mc.client_message_id,{canonical:qc&&!x.isMultichat(pc)});}function kb(lc){return lc.getError()?'_'+lc.getError():'';}function lb(lc,mc,nc){if(Math.floor(Math.random()*2)===0)if(mc.client_message_id in lc._sentMessagesTimestamp){var oc=lc._sentMessagesTimestamp[mc.client_message_id],pc=Date.now()-oc,qc=mc.client_thread_id;if(!qc)if(t.MercuryFBIDGK){qc=fb(lc,mc.thread_fbid);}else qc=eb(lc,mc.thread_id);j.log('WebMessagingLatencyLoggerConfig',{has_attachment:mc.attachments&&mc.attachments.length>0,latency:pc,is_canonical:!x.isMultichat(qc),send_successful:nc,source:'client'});}}function mb(lc,mc){var nc=null;switch(mc.status){case p.SUCCESS:nc='success';break;case p.FAILED_UNKNOWN_REASON:nc='confirmed_error';break;case p.UNABLE_TO_CONFIRM:nc='confirm_error';break;default:return;}if(t.MercuryFBIDGK){jb(lc,mc,nc);}else ib(lc,mc,nc);}function nb(lc,mc){(mc.message_counts||[]).forEach(function(vc){if(t.MercuryActionIDGK){ta(lc,vc.seen_timestamp);}else sa(lc,vc.last_action_id);});(mc.threads||[]).forEach(function(vc){ua(lc,vc);delete lc._fetchingThreads[vc.thread_id];var wc=ab(lc,vc.thread_id);delete lc._fetchingThreads[wc];sa(lc,vc.last_action_id);});(mc.ordered_threadlists||[]).forEach(function(vc){vc.thread_ids=vc.thread_ids.map(eb.bind(null,lc));});mc.actions=mc.actions||[];mc.actions.forEach(function(vc){mb(lc,vc);if(vc.status&&vc.status!=p.SUCCESS&&!vc.thread_id){vc.thread_id=vc.client_thread_id;return;}if(vc.action_type==q.SEND_MESSAGE&&vc.client_thread_id&&vc.client_thread_id!=v.PENDING_THREAD_ID&&vc.thread_id)wa(lc,vc.thread_id,vc.client_thread_id);vc.server_thread_id=vc.thread_id;if(vc.thread_id){vc.thread_id=cb(lc,vc.thread_id)?eb(lc,vc.thread_id):null;}else if(vc.client_thread_id)vc.thread_id=vc.client_thread_id;sa(lc,vc.action_id);});if(mc.end_of_history){var nc=[];for(var oc=0;oc<mc.end_of_history.length;oc++){var pc=mc.end_of_history[oc];if(pc.type=='user'){nc.push('user:'+pc.id);}else if(pc.type=='thread'&&cb(lc,pc.id))nc.push(eb(lc,pc.id));}mc.end_of_history=nc;}if(mc.roger){var qc={};for(var rc in mc.roger){var sc=lc._serverToClientIDs.getResource(rc);if(sc){var tc=mc.roger[rc];qc[sc]={};for(var uc in tc)qc[sc]['fbid:'+uc]=tc[uc];}}mc.roger=qc;}}function ob(lc,mc){(mc.message_counts||[]).forEach(function(vc){sa(lc,vc.last_action_id);});(mc.threads||[]).forEach(function(vc){va(lc,vc);delete lc._fetchingThreads[vc.thread_id];var wc=bb(lc,vc.thread_id);delete lc._fetchingThreads[wc];if(t.MercuryActionIDGK){ta(lc,vc.timestamp);}else sa(lc,vc.last_action_id);});(mc.ordered_threadlists||[]).forEach(function(vc){var wc=vc.thread_fbids||[];wc=wc.concat(vc.other_user_fbids||[]);vc.thread_ids=wc.map(fb.bind(null,lc));});mc.actions=mc.actions||[];mc.actions.forEach(function(vc){mb(lc,vc);var wc=vc.thread_fbid;if(vc.other_user_fbid)wc=vc.other_user_fbid;if(vc.status&&vc.status!=p.SUCCESS&&!wc){vc.thread_id=vc.client_thread_id;return;}if(vc.action_type==q.SEND_MESSAGE&&vc.client_thread_id&&vc.client_thread_id!=v.PENDING_THREAD_ID&&wc)xa(lc,wc.toString(),vc.client_thread_id);var xc=vc.thread_id;if(wc){vc.thread_id=db(lc,wc)?fb(lc,wc):null;}else if(vc.client_thread_id)vc.thread_id=vc.client_thread_id;if(!vc.thread_id)vc.server_thread_id=xc;if(t.MercuryActionIDGK){ta(lc,vc.timestamp);}else sa(lc,vc.action_id);});if(mc.end_of_history){var nc=[];for(var oc=0;oc<mc.end_of_history.length;oc++){var pc=mc.end_of_history[oc];if(pc.type=='user'){nc.push('user:'+pc.fbid);}else if(pc.type=='thread'&&db(lc,pc.fbid))nc.push(fb(lc,pc.fbid));}mc.end_of_history=nc;}if(mc.roger){var qc={};for(var rc in mc.roger){var sc=lc._serverToClientIDs.getResource(rc);if(sc){var tc=mc.roger[rc];qc[sc]={};for(var uc in tc)qc[sc]['fbid:'+uc]=tc[uc];}}mc.roger=qc;}}function pb(lc){if(lc._pendingUpdates&&lc._pendingUpdates.length){var mc=lc._pendingUpdates[0];lc._pendingUpdates=lc._pendingUpdates.slice(1);lc.handleUpdate(mc);}}function qb(lc,mc){var nc=na({},lc),oc;if(mc.threads){if(!nc.threads)nc.threads={};for(oc in mc.threads)nc.threads[oc]=Object.keys(oa((nc.threads[oc]||[]).concat(mc.threads[oc])));}if(mc.messages){if(!nc.messages)nc.messages={};for(oc in mc.messages){if(!nc.messages[oc])nc.messages[oc]={};for(var pc in mc.messages[oc])if(nc.messages[oc][pc]){nc.messages[oc][pc]=tb(nc.messages[oc][pc],mc.messages[oc][pc]);}else nc.messages[oc][pc]=mc.messages[oc][pc];}}nc.client=lc.client||mc.client;return nc;}function rb(lc,mc){var nc=na(oa(lc.folders,true),oa(mc.folders,true)),oc=lc.client||mc.client;return {folders:Object.keys(nc),client:oc};}function sb(lc,mc){for(var nc in mc)if(lc[nc]&&typeof lc[nc]==='object'){lc[nc]=tb(lc[nc],mc[nc]);}else if(mc[nc]&&typeof mc[nc]==='object'){var oc={};na(oc,mc[nc]);lc[nc]=oc;}return lc;}function tb(lc,mc){var nc=lc.offset<mc.offset?lc.offset:mc.offset,oc=lc.offset+lc.limit,pc=mc.offset+mc.limit,qc=(oc>pc)?oc:pc,rc=qc-nc;return {offset:nc,limit:rc};}function ub(lc,mc){var nc=lc.client||mc.client,oc={ids:{},client:nc};na(oc.ids,lc.ids);na(oc.ids,mc.ids);return oc;}function vb(lc,mc){var nc={},oc,pc=lc.client||mc.client;delete lc.client;delete mc.client;for(oc in lc)na(nc,oa(lc[oc],oc));for(oc in mc)na(nc,oa(mc[oc],oc));var qc={client:pc};for(var rc in nc){oc=nc[rc];if(!qc[oc])qc[oc]=[];qc[oc].push(rc);}return qc;}function wb(lc,mc){var nc=lc.client||mc.client,oc=oa(lc.ids,true),pc=oa(mc.ids,true),qc=na(oc,pc);return {ids:Object.keys(qc),client:nc};}function xb(lc){this._fbid=lc;this._lastActionId=0;this._lastActionTimestamp=0;this._serverToClientIDs=new n();this._clientToServerIDs=new n();this._FBIDToClientIDs=new n();this._clientIDToFBIDs=new n();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};this._sentMessagesTimestamp={};jc(this);}na(xb.prototype,h,{tokenizeThreadID:function(lc){s.isThreadID(lc);return x.tokenize(lc);},getServerThreadID:function(lc,mc){s.isThreadID(lc);if(t.MercuryFBIDGK){za(this,lc,mc);}else ya(this,lc,mc);},getThreadFBID:function(lc,mc){s.isThreadID(lc);za(this,lc,mc);},getClientThreadID:function(lc,mc){if(t.MercuryFBIDGK){hb(this,lc,mc);}else gb(this,lc,mc);},getClientThreadIDNow:function(lc){if(t.MercuryFBIDGK){return fb(this,lc);}else return eb(this,lc);},getServerThreadIDNow:function(lc){if(t.MercuryFBIDGK){return bb(this,lc);}else return ab(this,lc);},getClientThreadIDForPermalinks:function(lc){return eb(this,lc);},convertThreadIDIfAvailable:function(lc){var mc;if(t.MercuryFBIDGK){mc=this._FBIDToClientIDs.getResource(lc);if(mc===undefined){return lc;}else return mc;}else{mc=this._serverToClientIDs.getResource(lc);if(mc===undefined){return lc;}else return mc;}},isUser:function(lc){return lc<2.2e+09||(lc>=1e+14&&lc<=100099999989999)||(lc>=8.9e+13&&lc<=89999999999999);},canLinkExternallyThreadID:function(lc){s.isThreadID(lc);var mc=this.tokenizeThreadID(lc);return (mc.type=='user')||!!ab(this,lc);},canLinkExternallyFBID:function(lc){s.isThreadID(lc);var mc=this.tokenizeThreadID(lc);return (mc.type=='user')||!!bb(this,lc);},canLinkExternally:function(lc){if(t.MercuryFBIDGK){return this.canLinkExternallyFBID(lc);}else return this.canLinkExternallyThreadID(lc);},fetchThreadlistInfo:function(lc,mc,nc,oc,pc){nc=nc||ka.INBOX;pc=pc||ra;var qc=oc?la.IMMEDIATE:null,rc={client:pc};rc[nc]={offset:lc,limit:mc,filter:oc};kc(this,'/ajax/mercury/threadlist_info.php',rc,qc);},fetchUnseenThreadIDs:function(lc,mc){mc=mc||ra;this.fetchThreadlistInfo(ga.RECENT_THREAD_OFFSET,ga.JEWEL_THREAD_COUNT,lc,null,mc);},fetchUnreadThreadIDs:function(lc,mc){mc=mc||ra;kc(this,'/ajax/mercury/unread_threads.php',{folders:[lc],client:mc});},fetchMissedMessages:function(lc,mc){mc=mc||ra;var nc={last_action_timestamp:this._lastActionTimestamp,folders:lc,client:mc};if(t.MercuryActionIDGK){nc.last_action_timestamp=this._lastActionTimestamp;}else nc.last_action_id=this._lastActionId;kc(this,'/ajax/mercury/thread_sync.php',nc);},fetchThreadData:function(lc,mc){if(t.MercuryFBIDGK){this.fetchThreadDataFBID(lc,mc);}else this.fetchThreadDataThreadID(lc,mc);},fetchThreadDataThreadID:function(lc,mc){mc=mc||ra;s.allThreadID(lc);var nc={threads:{},client:mc},oc=[],pc=[];lc.forEach(function(rc){if(this._fetchingThreads[rc])return;this._fetchingThreads[rc]=true;var sc=ab(this,rc);if(sc){pc.push(sc);nc.threads.thread_ids=pc;}else{var tc=this.tokenizeThreadID(rc);if(tc.type=='user'){oc.push(tc.value);nc.threads.user_ids=oc;}else if(tc.type=='thread'){pc.push(tc.value);nc.threads.thread_ids=pc;}else if(tc.type!='root'&&tc.type!='pending')throw new Error('Unknown thread type',tc);}}.bind(this));this.inform("fetch-thread-data",nc);for(var qc in nc.threads){kc(this,'/ajax/mercury/thread_info.php',nc);break;}},fetchThreadDataFBID:function(lc,mc){mc=mc||ra;s.allThreadID(lc);var nc={threads:{},client:mc},oc=[],pc=[];lc.forEach(function(rc){if(this._fetchingThreads[rc])return;this._fetchingThreads[rc]=true;var sc=bb(this,rc),tc=this.tokenizeThreadID(rc);if(tc.type=='user'){oc.push(tc.value);nc.threads.user_ids=oc;}else if(tc.type=='thread'){if(sc){pc.push(sc);}else pc.push(tc.value);nc.threads.thread_fbids=pc;}else if(tc.type!='root'&&tc.type!='pending')throw new Error('Unknown thread type',tc);}.bind(this));this.inform("fetch-thread-data",nc);for(var qc in nc.threads){kc(this,'/ajax/mercury/thread_info.php',nc);break;}},ensureThreadIsFetched:function(lc,mc){if(t.MercuryFBIDGK){this.ensureThreadIsFetchedFBID(lc,mc);}else this.ensureThreadIsFetchedThreadID(lc,mc);},ensureThreadIsFetchedThreadID:function(lc,mc){mc=mc||ra;if(!this._serverToClientIDs.getResource(lc)&&!this._fetchingThreads[lc]){this._fetchingThreads[lc]=true;kc(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[lc]},client:mc});}},ensureThreadIsFetchedFBID:function(lc,mc){mc=mc||ra;if(!this._FBIDToClientIDs.getResource(lc)&&!this._fetchingThreads[lc]){this._fetchingThreads[lc]=true;kc(this,'/ajax/mercury/thread_info.php',{threads:{thread_fbids:[lc]},client:mc});}},fetchThreadMessages:function(lc,mc,nc,oc,pc){if(t.MercuryFBIDGK){this.fetchThreadMessagesFBID(lc,mc,nc,oc,pc);}else this.fetchThreadMessagesThreadID(lc,mc,nc,oc,pc);},fetchThreadMessagesThreadID:function(lc,mc,nc,oc,pc){s.isThreadID(lc);pc=pc||ra;var qc,rc,sc=this.tokenizeThreadID(lc),tc=ab(this,lc),uc=false;if(tc){rc='thread_ids';qc=tc;}else{qc=sc.value;switch(sc.type){case 'user':rc='user_ids';uc=true;break;case 'thread':rc='thread_ids';break;}}var vc={messages:{},threads:{},client:pc};if(rc){vc.messages[rc]={};vc.messages[rc][qc]={offset:mc,limit:nc};if(uc)vc.threads[rc]=[qc];kc(this,'/ajax/mercury/thread_info.php',vc,oc);}else ya(this,lc,function(wc){vc.messages.thread_ids={};vc.messages.thread_ids[wc]={offset:mc,limit:nc};kc(this,'/ajax/mercury/thread_info.php',vc,oc);}.bind(this));},fetchThreadMessagesFBID:function(lc,mc,nc,oc,pc){s.isThreadID(lc);pc=pc||ra;var qc,rc,sc=this.tokenizeThreadID(lc),tc=bb(this,lc),uc=false;if(tc){qc=tc;rc=(sc.type=='user')?'user_ids':'thread_fbids';}else{qc=sc.value;switch(sc.type){case 'user':rc='user_ids';uc=true;break;case 'thread':rc='thread_fbids';break;}}var vc={messages:{},threads:{},client:pc};if(rc){vc.messages[rc]={};vc.messages[rc][qc]={offset:mc,limit:nc};if(uc)vc.threads[rc]=[qc];kc(this,'/ajax/mercury/thread_info.php',vc,oc);}else za(this,lc,function(wc){vc.messages.thread_fbids={};vc.messages.thread_fbids[wc]={offset:mc,limit:nc};kc(this,'/ajax/mercury/thread_info.php',vc,oc);}.bind(this));},handleThreadInfoError:function(lc){if(t.MercuryFBIDGK){this.handleThreadInfoErrorFBID(lc);}else this.handleThreadInfoErrorThreadID(lc);},handleThreadInfoErrorThreadID:function(lc){var mc=lc.getRequest().getData(),nc=[];if(mc.messages){for(var oc in mc.messages.thread_ids)nc.push(yb(eb(this,oc)));for(var pc in mc.messages.user_ids)nc.push(yb('user:'+pc));for(var qc in mc.messages.group_ids)nc.push(yb('group:'+qc));}if(nc.length)this.handleUpdate({actions:nc,from_client:true,payload_source:ba.CLIENT_CHANNEL_MESSAGE});if(mc.threads&&(mc.threads.user_ids||mc.threads.group_ids||mc.threads.thread_ids)){var rc=5,sc=true;if(!mc.retry_count){mc.retry_count=0;if(mc.messages)delete mc.messages;}else if(mc.retry_count>=rc){sc=false;(mc.threads.thread_ids||[]).forEach(function(uc){if(uc in this._fetchingThreads)delete this._fetchingThreads[uc];}.bind(this));}if(sc){var tc=mc.retry_count*1000;pa(function(){qa.log('retry_thread',mc);kc(this,'/ajax/mercury/thread_info.php',mc);}.bind(this),tc);mc.retry_count++;}}},handleThreadInfoErrorFBID:function(lc){var mc=lc.getRequest().getData(),nc=[];if(mc.messages){for(var oc in mc.messages.thread_fbids)nc.push(yb(fb(this,oc)));for(var pc in mc.messages.user_ids)nc.push(yb('user:'+pc));for(var qc in mc.messages.group_ids)nc.push(yb('group:'+qc));}if(nc.length)this.handleUpdate({actions:nc,from_client:true,payload_source:ba.CLIENT_CHANNEL_MESSAGE});if(mc.threads&&(mc.threads.user_ids||mc.threads.group_ids||mc.threads.thread_ids)){var rc=5,sc=true;if(!mc.retry_count){mc.retry_count=0;if(mc.messages)delete mc.messages;}else if(mc.retry_count>=rc){sc=false;(mc.threads.thread_ids||[]).forEach(function(uc){if(uc in this._fetchingThreads)delete this._fetchingThreads[uc];}.bind(this));}if(sc){var tc=mc.retry_count*1000;pa(function(){qa.log('retry_thread',mc);kc(this,'/ajax/mercury/thread_info.php',mc);}.bind(this),tc);mc.retry_count++;}}},markFolderAsRead:function(lc){kc(this,'/ajax/mercury/mark_folder_as_read.php',{folder:lc});var mc=[{action_type:w.MARK_ALL_READ,action_id:null,folder:lc}];this.handleUpdate({global_actions:mc,from_client:true,payload_source:ba.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(lc,mc,nc){if(t.MercuryFBIDGK){this.changeThreadReadStatusFBID(lc,mc,nc);}else this.changeThreadReadStatusThreadID(lc,mc,nc);},changeThreadReadStatusThreadID:function(lc,mc,nc){s.isThreadID(lc);ya(this,lc,function(pc){var qc={ids:{}};qc.ids[pc]=mc;kc(this,'/ajax/mercury/change_read_status.php',qc);}.bind(this));var oc=[{action_type:q.CHANGE_READ_STATUS,action_id:null,thread_id:lc,mark_as_read:mc,folder:nc}];this.handleUpdate({actions:oc,from_client:true,payload_source:ba.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatusFBID:function(lc,mc,nc){s.isThreadID(lc);za(this,lc,function(pc){var qc={ids:{}};qc.ids[pc]=mc;kc(this,'/ajax/mercury/change_read_status.php',qc);}.bind(this));var oc=[{action_type:q.CHANGE_READ_STATUS,action_id:null,thread_id:lc,mark_as_read:mc,folder:nc}];this.handleUpdate({actions:oc,from_client:true,payload_source:ba.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(lc,mc){if(t.MercuryFBIDGK){this.changeThreadArchivedStatusFBID(lc,mc);}else this.changeThreadArchivedStatusThreadID(lc,mc);},changeThreadArchivedStatusThreadID:function(lc,mc){s.isThreadID(lc);ya(this,lc,function(pc){var qc={ids:{}};qc.ids[pc]=mc;kc(this,'/ajax/mercury/change_archived_status.php',qc);}.bind(this));var nc={action_type:q.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:lc,archived:mc},oc={actions:[nc],from_client:true,payload_source:ba.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(oc);},changeThreadArchivedStatusFBID:function(lc,mc){s.isThreadID(lc);za(this,lc,function(pc){var qc={ids:{}};qc.ids[pc]=mc;kc(this,'/ajax/mercury/change_archived_status.php',qc);}.bind(this));var nc={action_type:q.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:lc,archived:mc},oc={actions:[nc],from_client:true,payload_source:ba.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(oc);},changeThreadFolder:function(lc,mc){if(t.MercuryFBIDGK){this.changeThreadFolderFBID(lc,mc);}else this.changeThreadFolderThreadID(lc,mc);},changeThreadFolderThreadID:function(lc,mc){s.isThreadID(lc);ya(this,lc,function(pc){var qc={};qc[mc]=[pc];kc(this,'/ajax/mercury/move_thread.php',qc);}.bind(this));var nc={action_type:q.CHANGE_FOLDER,action_id:null,thread_id:lc,new_folder:mc},oc={actions:[nc],from_client:true,payload_source:ba.CLIENT_CHANGE_FOLDER};this.handleUpdate(oc);},changeThreadFolderFBID:function(lc,mc){s.isThreadID(lc);za(this,lc,function(pc){var qc={};qc[mc]=[pc];kc(this,'/ajax/mercury/move_thread.php',qc);}.bind(this));var nc={action_type:q.CHANGE_FOLDER,action_id:null,thread_id:lc,new_folder:mc},oc={actions:[nc],from_client:true,payload_source:ba.CLIENT_CHANGE_FOLDER};this.handleUpdate(oc);},changeMutingOnThread:function(lc,mc){if(t.ActionFBIDGK){this.changeMutingOnThreadFBID(lc,mc);}else this.changeMutingOnThreadThreadID(lc,mc);},changeMutingOnThreadThreadID:function(lc,mc){s.isThreadID(lc);ya(this,lc,function(pc){kc(this,'/ajax/mercury/change_mute_thread.php',{thread_id:pc,mute_settings:mc,payload_source:ra});}.bind(this));var nc={action_type:q.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:lc,mute_settings:mc},oc={actions:[nc],from_client:true,payload_source:ba.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(oc);},changeMutingOnThreadFBID:function(lc,mc){s.isThreadID(lc);za(this,lc,function(pc){kc(this,'/ajax/mercury/change_mute_thread.php',{thread_fbid:pc,mute_settings:mc,payload_source:ra});}.bind(this));var nc={action_type:q.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:lc,mute_settings:mc},oc={actions:[nc],from_client:true,payload_source:ba.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(oc);},markThreadSpam:function(lc){if(t.MercuryFBIDGK){this.markThreadSpamFBID(lc);}else this.markThreadSpamThreadID(lc);},markThreadSpamThreadID:function(lc){s.isThreadID(lc);ya(this,lc,function(oc){kc(this,'/ajax/mercury/mark_spam.php',{id:oc});}.bind(this));var mc={action_type:q.CHANGE_FOLDER,action_id:null,thread_id:lc,new_folder:ka.SPAM},nc={actions:[mc],from_client:true,payload_source:ba.CLIENT_CHANGE_FOLDER};this.handleUpdate(nc);},markThreadSpamFBID:function(lc){s.isThreadID(lc);za(this,lc,function(oc){kc(this,'/ajax/mercury/mark_spam.php',{id:oc});}.bind(this));var mc={action_type:q.CHANGE_FOLDER,action_id:null,thread_id:lc,new_folder:ka.SPAM},nc={actions:[mc],from_client:true,payload_source:ba.CLIENT_CHANGE_FOLDER};this.handleUpdate(nc);},markMessagesSpam:function(lc,mc){ha.getServerIDs(mc||[],function(oc){kc(this,'/ajax/mercury/mark_spam_messages.php',{message_ids:oc});}.bind(this));var nc={action_type:q.DELETE_MESSAGES,action_id:null,thread_id:lc,message_ids:mc};this.handleUpdate({actions:[nc],from_client:true,payload_source:ba.CLIENT_DELETE_MESSAGES});},unmarkThreadSpam:function(lc){if(t.MercuryFBIDGK){this.unmarkThreadSpamFBID(lc);}else this.unmarkThreadSpamThreadID(lc);},unmarkThreadSpamThreadID:function(lc){s.isThreadID(lc);ya(this,lc,function(oc){kc(this,'/ajax/mercury/unmark_spam.php',{id:oc});}.bind(this));var mc={action_type:q.CHANGE_FOLDER,action_id:null,thread_id:lc,new_folder:ka.INBOX},nc={actions:[mc],from_client:true,payload_source:ba.CLIENT_CHANGE_FOLDER};this.handleUpdate(nc);},unmarkThreadSpamFBID:function(lc){s.isThreadID(lc);za(this,lc,function(oc){kc(this,'/ajax/mercury/unmark_spam.php',{id:oc});}.bind(this));var mc={action_type:q.CHANGE_FOLDER,action_id:null,thread_id:lc,new_folder:ka.INBOX},nc={actions:[mc],from_client:true,payload_source:ba.CLIENT_CHANGE_FOLDER};this.handleUpdate(nc);},deleteThread:function(lc){if(t.MercuryFBIDGK){this.deleteThreadFBID(lc);}else this.deleteThreadThreadID(lc);},deleteThreadThreadID:function(lc){s.isThreadID(lc);ya(this,lc,function(oc){var pc={ids:[oc]};kc(this,'/ajax/mercury/delete_thread.php',pc);}.bind(this));var mc={action_type:q.DELETE_THREAD,action_id:null,thread_id:lc},nc={actions:[mc],from_client:true,payload_source:ba.CLIENT_DELETE_THREAD};this.handleUpdate(nc);},deleteThreadFBID:function(lc){s.isThreadID(lc);za(this,lc,function(oc){var pc={ids:[oc]};kc(this,'/ajax/mercury/delete_thread.php',pc);}.bind(this));var mc={action_type:q.DELETE_THREAD,action_id:null,thread_id:lc},nc={actions:[mc],from_client:true,payload_source:ba.CLIENT_DELETE_THREAD};this.handleUpdate(nc);},deleteMessages:function(lc,mc,nc){ha.getServerIDs(mc||[],function(pc){kc(this,'/ajax/mercury/delete_messages.php',{message_ids:pc});}.bind(this));var oc;if(nc){oc={action_type:q.DELETE_THREAD,action_id:null,thread_id:lc};}else oc={action_type:q.DELETE_MESSAGES,action_id:null,thread_id:lc,message_ids:mc};this.handleUpdate({actions:[oc],from_client:true,payload_source:ba.CLIENT_DELETE_MESSAGES});},clearChat:function(lc,mc,nc){s.isThreadID(lc);kc(this,'/ajax/chat/settings.php',{clear_history_id:mc});var oc=[{action_type:q.CLEAR_CHAT,action_id:null,thread_id:lc,clear_time:nc}];this.handleUpdate({actions:oc,from_client:true,payload_source:ba.CLIENT_CLEAR_CHAT});},sendNewMessage:function(lc,mc){if(t.MercuryFBIDGK){this.sendNewMessageFBID(lc,mc);}else this.sendNewMessageThreadID(lc,mc);},sendNewMessageThreadID:function(lc,mc){mc=mc||ra;if(!lc.client_state||lc.client_state==aa.SEND_TO_SERVER)ha.getServerIDs(lc.forward_message_ids||[],function(oc){var pc=lc.thread_id,qc=this.tokenizeThreadID(lc.thread_id),rc=qc.type,sc=na({},lc);sc.forward_message_ids=oc;if((rc=='root'&&qc.value==sc.message_id)||(rc=='user'&&!ab(this,pc))||(lc.thread_id==v.PENDING_THREAD_ID)){sc.client_thread_id=sc.thread_id;sc.thread_id=null;this._sendNewMessageToServer(sc,mc);}else ya(this,sc.thread_id,function(tc){sc.thread_id=tc;this._sendNewMessageToServer(sc);}.bind(this));}.bind(this));if(lc.thread_id!=v.PENDING_THREAD_ID){var nc={actions:[na({},lc)],from_client:true,payload_source:ba.CLIENT_SEND_MESSAGE};this.handleUpdate(nc);}},sendNewMessageFBID:function(lc,mc){mc=mc||ra;if(!lc.client_state||lc.client_state==aa.SEND_TO_SERVER)ha.getServerIDs(lc.forward_message_ids||[],function(oc){var pc=lc.thread_id,qc=this.tokenizeThreadID(lc.thread_id),rc=qc.type,sc=na({},lc);sc.forward_message_ids=oc;if((rc=='root'&&qc.value==sc.message_id)||(rc=='user')||(pc==v.PENDING_THREAD_ID)){sc.client_thread_id=sc.thread_id;sc.thread_id=null;this._sendNewMessageToServer(sc,mc);}else za(this,sc.thread_id,function(tc){qc=this.tokenizeThreadID(sc.thread_id);if(qc.type=='user'){sc.other_user_fbid=qc.values;}else sc.thread_fbid=tc;sc.thread_id=null;this._sendNewMessageToServer(sc);}.bind(this));}.bind(this));if(lc.thread_id!=v.PENDING_THREAD_ID){var nc={actions:[na({},lc)],from_client:true,payload_source:ba.CLIENT_SEND_MESSAGE};this.handleUpdate(nc);}},_sendNewMessageToServer:function(lc,mc){g.inform(k.ATTEMPT_RECONNECT);mc=mc||ra;this._sentMessagesTimestamp[lc.message_id]=Date.now();kc(this,'/ajax/mercury/send_messages.php',{message_batch:[lc],client:mc});},requestMessageConfirmation:function(lc,mc){if(t.MercuryFBIDGK){this.requestMessageConfirmationFBID(lc,mc);}else this.requestMessageConfirmationThreadID(lc,mc);},requestMessageConfirmationThreadID:function(lc,mc){mc=mc||ra;var nc={},oc={};for(var pc in lc){var qc=ab(this,pc);if(qc){nc[qc]=lc[pc];}else{var rc=lc[pc];for(var sc=0;sc<rc.length;sc++)oc[rc[sc]]=pc;}}var tc=Object.keys(nc),uc=Object.keys(oc);if(tc.length||uc.length)kc(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:nc,local_messages:oc,client:mc});},requestMessageConfirmationFBID:function(lc,mc){mc=mc||ra;var nc={},oc={};for(var pc in lc){var qc=bb(this,pc);if(qc){nc[qc]=lc[pc];}else{var rc=lc[pc];for(var sc=0;sc<rc.length;sc++)oc[rc[sc]]=pc;}}var tc=Object.keys(nc),uc=Object.keys(oc);if(tc.length||uc.length)kc(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:nc,local_messages:oc,client:mc});},handleMessageConfirmError:function(lc){if(t.MercuryFBIDGK){this.handleMessageConfirmErrorFBID(lc);}else this.handleMessageConfirmErrorThreadID(lc);},handleMessageConfirmErrorThreadID:function(lc){var mc=lc.getRequest().getData().thread_message_map,nc=lc.getRequest().getData().local_messages;if(!mc&&!nc)return;var oc=[];for(var pc in mc){var qc=mc[pc];qc.forEach(function(tc){oc.push({action_type:q.SEND_MESSAGE,client_message_id:tc,message_id:tc,client_thread_id:null,thread_id:pc,status:p.UNABLE_TO_CONFIRM});});}for(var rc in nc){var sc=nc[rc];oc.push({action_type:q.SEND_MESSAGE,client_message_id:rc,message_id:rc,client_thread_id:sc,thread_id:null,status:p.UNABLE_TO_CONFIRM});}if(oc.length)this.handleUpdate({actions:oc,payload_source:ba.CLIENT_HANDLE_ERROR});},handleMessageConfirmErrorFBID:function(lc){var mc=lc.getRequest().getData().thread_message_map,nc=lc.getRequest().getData().local_messages;if(!mc&&!nc)return;var oc=[];for(var pc in mc){var qc=mc[pc];qc.forEach(function(tc){oc.push({action_type:q.SEND_MESSAGE,client_message_id:tc,message_id:tc,client_thread_id:null,thread_fbid:pc,status:p.UNABLE_TO_CONFIRM});});}for(var rc in nc){var sc=nc[rc];oc.push({action_type:q.SEND_MESSAGE,client_message_id:rc,message_id:rc,client_thread_id:sc,thread_fbid:null,status:p.UNABLE_TO_CONFIRM});}if(oc.length)this.handleUpdate({actions:oc,payload_source:ba.CLIENT_HANDLE_ERROR});},markSeen:function(){var lc=l.convertActionIDToTimestamp(this._lastActionId);if(t.MercuryActionIDGK)lc=this._lastActionTimestamp;kc(this,'/ajax/mercury/mark_seen.php',{seen_timestamp:lc});},handleRoger:function(lc){var mc=lc.tid?this._serverToClientIDs.getResource(lc.tid):('user:'+lc.reader);if(mc){var nc={};nc[mc]={};nc[mc]['fbid:'+lc.reader]=lc.time;this.inform('update-roger',nc);}},handleUpdateWaitForThread:function(lc,mc,nc){if(t.MercuryFBIDGK){this.handleUpdateWaitForThreadFBID(lc,mc,nc);}else this.handleUpdateWaitForThreadThreadID(lc,mc,nc);},handleUpdateWaitForThreadThreadID:function(lc,mc,nc){nc=nc||ra;var oc=this._serverToClientIDs.getResource(mc);if(oc){this.handleUpdate(lc);return;}this._serverToClientIDs.executeOrEnqueue(mc,function(){this._pendingUpdates.push(lc);}.bind(this));if(!this._fetchingThreads[mc]){this._fetchingThreads[mc]=true;kc(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[mc]},client:nc});}},handleUpdateWaitForThreadFBID:function(lc,mc,nc){nc=nc||ra;var oc=this._FBIDToClientIDs.getResource(mc);if(oc){this.handleUpdate(lc);return;}this._FBIDToClientIDs.executeOrEnqueue(mc,function(){this._pendingUpdates.push(lc);}.bind(this));if(!this._fetchingThreads[mc]){this._fetchingThreads[mc]=true;var pc={threads:{thread_fbids:[mc]},client:nc};if(this.isUser(mc))pc={threads:{user_ids:[mc]},client:nc};kc(this,'/ajax/mercury/thread_info.php',pc);}},handleUpdate:function(lc){var mc=[];if(lc&&lc.threads)for(var nc=0;nc<lc.threads.length;nc++){if(!lc.threads[nc].snippet_attachments)continue;for(var oc=0;oc<lc.threads[nc].snippet_attachments.length;oc++)if(lc.threads[nc].snippet_attachments[oc].share_xhp){mc.push({i:nc,j:oc,xhp:lc.threads[nc].snippet_attachments[oc].share_xhp});lc.threads[nc].snippet_attachments[oc].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}var pc=[];if(lc)for(var qc in lc.actions){var rc=na({},lc.actions[qc]);y.obfuscateMessage(rc);pc.push(rc);}var sc=pc.length?na({},lc,{actions:pc}):lc;qa.debug('handle_update',{payload:sc,from_client:lc.from_client});for(var tc=0;tc<mc.length;tc++)lc.threads[mc[tc].i].snippet_attachments[mc[tc].j].share_xhp=mc[tc].xhp;for(tc in lc){ma.getForFBID(this._fbid).synchronizeInforms(function(){if(!lc.from_client){if(t.MercuryFBIDGK){ob(this,lc);}else nb(this,lc);this.inform('payload-preprocessed',lc);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',lc);this.inform('update-threads',lc);this.inform('update-unread',lc);this.inform('update-threadlist',lc);this.inform('update-messages',lc);this.inform('update-unseen',lc);this.inform('update-typing-state',lc);this.inform('update-roger',lc.roger);this.inform('model-update-completed',null);pb(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(lc,mc,nc,oc){qa.debug('handle_send_message_error_common',{reliability_error_status:nc,request_error_status:mc});var pc=lc.getData(),qc=pc.message_batch,rc=qc.map(function(tc){var uc={action_type:q.SEND_MESSAGE,thread_id:tc.thread_id,client_message_id:tc.message_id,message_id:tc.message_id,client_thread_id:tc.client_thread_id,status:mc,error_data:oc};if(t.MercuryFBIDGK){uc.thread_fbid=tc.thread_fbid;}else uc.thread_id=tc.thread_id;return uc;});if(t.MercuryFBIDGK){rc.forEach(function(tc){jb(this,tc,nc);}.bind(this));}else rc.forEach(function(tc){ib(this,tc,nc);}.bind(this));var sc={actions:rc,payload_source:ba.CLIENT_HANDLE_ERROR};this.handleUpdate(sc);},handleSendMessageError:function(lc){var mc=lc.getPayload(),nc=null,oc=null;if(mc&&mc.error_payload){nc=p.UNCONFIRMED;oc='send_error';}else{nc=p.ERROR;oc='request_error'+kb(lc);}var pc=lc.error;if(pc===1404102)i.verboseErrorHandler(lc);var qc=/<.*>/.test(lc.getErrorDescription())?lc.getErrorSummary():lc.getErrorDescription();this._handleSendMessageErrorCommon(lc.getRequest(),nc,oc,{type:u.SERVER,code:lc.getError(),description:qc,is_transient:lc.isTransient()});},handleSendMessageTransportError:function(lc){this._handleSendMessageErrorCommon(lc.getRequest(),p.ERROR,'transport_error'+kb(lc),{type:u.TRANSPORT,code:lc.getError(),is_transient:true});},handleSendMessageTimeout:function(lc){this._handleSendMessageErrorCommon(lc,p.ERROR,'transport_timeout',{type:u.TIMEOUT,is_transient:true});},getLastActionID:function(){return this._lastActionId;},getLastActionTimestamp:function(){return this._lastActionTimestamp;}});na(xb,ea);function yb(lc){return {action_type:q.LOG_MESSAGE,thread_id:lc,message_id:lc,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:fa.UNKNOWN,log_message_type:z.SERVER_ERROR,log_message_data:{}};}function zb(lc){var mc=lc.getData(),nc=mc.request_user_id?mc.request_user_id:m.getID();return xb.getForFBID(nc);}function ac(lc,mc){zb(mc).handleUpdate(lc);}function bc(lc,mc){var nc=lc.client||mc.client;return {client:nc,message_batch:lc.message_batch.concat(mc.message_batch)};}function cc(lc,mc){var nc={};na(nc,lc.ids);na(nc,mc.ids);var oc=lc.client||mc.client;return {ids:nc,client:oc};}function dc(lc,mc){return mc;}function ec(lc){var mc=zb(lc.getRequest());mc.handleThreadInfoError(lc);}function fc(lc){var mc=zb(lc.getRequest());mc.handleSendMessageError(lc);}function gc(lc){var mc=zb(lc.getRequest());mc.handleSendMessageTransportError(lc);}function hc(lc){var mc=zb(lc);mc.handleSendMessageTimeout(lc);}function ic(lc){var mc=zb(lc.getRequest());mc.handleMessageConfirmError(lc);}function jc(lc){la.registerEndpoints({'/ajax/mercury/thread_sync.php':{request_user_id:lc._fbid,mode:la.IDEMPOTENT,handler:ac},'/ajax/mercury/thread_info.php':{request_user_id:lc._fbid,mode:la.BATCH_DEFERRED_MULTI,batch_function:qb,handler:ac,error_handler:ec},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE,handler:ac},'/ajax/mercury/change_read_status.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE,batch_function:cc,handler:ac},'/ajax/mercury/send_messages.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE,batch_function:bc,batch_size_limit:ia.SEND_BATCH_LIMIT,handler:ac,error_handler:fc,transport_error_handler:gc,timeout:da.sendMessageTimeout,timeout_handler:hc,connection_retries:ia.SEND_CONNECTION_RETRIES},'/ajax/mercury/mark_seen.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE,batch_function:dc,handler:ac},'/ajax/mercury/confirm_messages.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE,handler:ac,error_handler:ic},'/ajax/mercury/threadlist_info.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE_UNIQUE,batch_function:sb,handler:ac},'/ajax/mercury/mark_spam.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE,handler:ac},'/ajax/mercury/mark_spam_messages.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE,handler:ac},'/ajax/mercury/unmark_spam.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE,handler:ac},'/ajax/mercury/unread_threads.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE_UNIQUE,batch_function:rb,handler:ac},'/ajax/chat/settings.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE,batch_function:ub,handler:ac},'/ajax/mercury/delete_thread.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE,batch_function:wb,handler:ac},'/ajax/mercury/delete_messages.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE,handler:ac},'/ajax/mercury/move_thread.php':{request_user_id:lc._fbid,mode:la.BATCH_SUCCESSIVE,batch_function:vb,handler:ac},'/ajax/mercury/change_mute_thread.php':{request_user_id:lc._fbid,mode:la.IMMEDIATE,handler:ac}});}function kc(lc,mc,nc,oc){la.trySend(mc,nc,oc,lc._fbid);}e.exports=xb;},null);
__d("MercuryParticipants",["CurrentUser","ImageSourceRequest","ImageSourceType","MercuryAssert","MercuryIDs","MercuryParticipantsConstants","MercuryParticipantTypes","PhotoResizeModeConst","ShortProfiles","copyProperties","getObjectValues","tx","MercuryServerRequests"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s=b('MercuryServerRequests').get(),t='fbid:'+g.getID(),u={},v={},w=function(ba){ba=z(ba);if(u[ba.id]){p(u[ba.id],ba);}else u[ba.id]=p({},ba);if(ba.vanity)v[ba.vanity]=ba.id;};function x(ba){j.isEmailParticipantID(ba);var ca=k.tokenize(ba),da=ca.value;return {gender:l.UNKNOWN_GENDER,href:null,id:ba,image_src:l.EMAIL_IMAGE,big_image_src:l.EMAIL_IMAGE,name:da,short_name:da,employee:false,call_promo:false};}function y(ba,ca,da){j.allParticipantIDs(ba);var ea={},fa={};ba.forEach(function(ha){if(u[ha]&&!da){ea[ha]=p({},u[ha]);}else{var ia=k.tokenize(ha);if(ia.type=='fbid'){var ja=ia.value;fa[ha]=ja;}else if(ia.type=='email')ea[ha]=x(ha);}});var ga=q(fa);if(ga.length){o.getMulti(ga,function(ha){for(var ia in fa){var ja=fa[ia],ka=ha[ja];ea[ia]={gender:ka.gender,href:ka.uri,id:ia,image_src:ka.thumbSrc,name:ka.name,short_name:ka.firstName,employee:ka.employee,call_promo:ka.showVideoPromo,type:ka.type,vanity:ka.vanity,is_friend:ka.is_friend,orion_eligible:ka.orionEligible,social_snippets:ka.social_snippets};w(ea[ia]);}ca(ea);});}else ca(ea);}function z(ba){var ca=ba.type===m.USER||ba.type===m.FRIEND;if(!ca)return ba;if(!ba.name&&!ba.href&&!ba.vanity){var da="Facebook User";ba.name=da;ba.short_name=da;}return ba;}var aa={user:t,isAuthor:function(ba){return ba===t;},getIDFromVanityOrFBID:function(ba){if(!ba)return;if(v[ba])return v[ba];if(ba.match('^\\d+$'))return aa.getIDForUser(ba);},getNow:function(ba){return u[ba];},get:function(ba,ca){j.isParticipantID(ba);aa.getMulti([ba],function(da){ca(da[ba]);});},getMulti:function(ba,ca,da){return y(ba,ca,false);},getMap:function(ba,ca){var da=[];for(var ea in ba)if(Array.isArray(ba[ea])){da=da.concat(ba[ea]);}else if(ba[ea])da.push(ba[ea]);this.getMulti(da,function(fa){var ga={};for(var ha in ba)if(Array.isArray(ba[ha])){ga[ha]=ba[ha].map(function(ia){return fa[ia];});}else ga[ha]=fa[ba[ha]];ca(ga);});},getBigImageMulti:function(ba,ca){j.allParticipantIDs(ba);var da=l.BIG_IMAGE_SIZE;aa.getMulti(ba,function(ea){var fa={},ga=0,ha=function(la,ma){ga++;fa[la]=ma;if(ga===ba.length)ca(fa);},ia=function(la,ma){u[la].big_image_src=ma.uri;ha(la,ma.uri);};for(var ja in ea){var ka=ea[ja];if(!ka.big_image_src){new h().setFBID(aa.getUserID(ja)).setType(i.PROFILE_PICTURE).setDimensions(da,da).setResizeMode(n.COVER).setCallback(ia.bind(null,ja)).send();}else ha(ka.id,ka.big_image_src);}});},getOrderedBigImageMulti:function(ba,ca){aa.getBigImageMulti(ba,function(da){var ea=ba.map(function(fa){return da[fa];});ca(ea);});},getMultiForceDownload:function(ba,ca){return y(ba,ca,true);},getUserID:function(ba){return k.getUserIDFromParticipantID(ba);},getIDForUser:function(ba){return 'fbid:'+ba;},addParticipants:function(ba){ba.forEach(w);}};s.subscribe('update-participants',function(ba,ca){aa.addParticipants(ca.participants||[]);});e.exports=aa;},null);
__d("MercuryFolders",["MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h){var i=[g.INBOX,g.OTHER,g.ACTION_ARCHIVED,g.SPAM],j={getSupportedFolders:function(){return i.concat();},isSupportedFolder:function(k){return h(i,k);},getFromMeta:function(k){var l=k.folder;if(k.is_archived)l=g.ACTION_ARCHIVED;return l;}};e.exports=j;},null);
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","startsWith"],function(a,b,c,d,e,f,g,h,i){var j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(i(k,'image')){return 'MercuryPhotoIcon';}else if(i(k,'video')){return 'MercuryVideoIcon';}else if(i(k,'audio')){return 'MercuryMusicIcon';}else if(i(k,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(i(k,'image')){return g.PHOTO;}else if(i(k,'video')){return g.VIDEO;}else if(i(k,'audio')){return g.MUSIC;}else if(i(k,'text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';l.push(p);}}return l;},get:function(k){var l=[];if(k.attachments){l=k.attachments;}else if(k.raw_attachments)l=this.convertRaw(k.raw_attachments);if(!(k.attachments&&k.attachments.length>0)&&k.preview_attachments&&k.preview_attachments.length>0)return l.concat(k.preview_attachments);return l;}};e.exports=j;},null);
__d("MercuryThreads",["TimestampConverter","MercuryFolders","KeyedCallbackManager","MercuryActionTypeConstants","MercuryAssert","MercuryAttachment","MercuryConfig","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercurySingletonMixin","MercuryThreadMode","MessagingTag","MercuryParticipants","ReportState","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom","removeFromArray"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z){function aa(na,oa,pa){var qa=y(oa.participants,true),ra=t.getIDForUser(na._fbid);pa.forEach(function(sa){if(qa[sa]!==true){oa.participants.push(sa);if(sa===ra)oa.is_subscribed=true;}});}function ba(na,oa,pa){pa.forEach(function(qa){z(oa.participants,qa);if(qa===t.getIDForUser(na._fbid))oa.is_subscribed=false;});}function ca(na,oa){if(na.participants[0]!=oa){z(na.participants,oa);na.participants.unshift(oa);}}function da(na,oa){var pa=oa.body,qa=oa.subject,ra='';if(qa){qa=qa.toLowerCase();if(pa.slice(0,qa.length).toLowerCase()==qa){ra=pa;}else if(pa){ra=qa+' \u00B7 '+pa;}else ra=qa;}else ra=pa;na.snippet=ra;na.snippet_has_attachment=oa.has_attachment;if(oa.raw_attachments&&oa.raw_attachments.length>0){var sa=l.convertRaw(oa.raw_attachments);na.snippet_attachments=sa;}else na.snippet_attachments=oa.attachments;na.is_forwarded_snippet=!!oa.forward_count;na.snippet_sender=oa.author;}function ea(na,oa,pa){if(!oa)return false;if(!oa.timestamp)return true;var qa=!oa.unread_count;if(pa==qa)return false;oa.unread_count=pa?0:1;na._threadInformer.updatedThread(oa.thread_id);return true;}function fa(na,oa){var pa=na._threads.getAllResources();for(var qa in pa){var ra=pa[qa];if(ra.folder==oa){ra.unread_count=0;na._threads.setResource(qa,ra);na._threadInformer.updatedThread(qa);}}}function ga(na,oa,pa){if(!oa||oa.chat_clear_time===pa)return false;oa.chat_clear_time=pa;na._threadInformer.reorderedMessages(oa.thread_id);return true;}function ha(na,oa,pa,qa){if(pa.timestamp)na._threadInformer.changedThreadReadState(oa.thread_id,qa,pa.timestamp);ea(na,oa,qa);}function ia(na,oa,pa,qa){var ra=pa.action_type;if(ra==j.USER_GENERATED_MESSAGE||ra==j.LOG_MESSAGE){pa.is_unread&&oa.unread_count++;oa.message_count++;oa.is_archived=false;}switch(ra){case j.USER_GENERATED_MESSAGE:if(oa.last_read_timestamp>=pa.timestamp)ha(na,oa,pa,true);ca(oa,pa.author);break;case j.SEND_MESSAGE:var sa=pa.log_message_type;if(sa==p.THREAD_IMAGE)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;oa.snippet_attachments=pa.attachments;break;case j.LOG_MESSAGE:var sa=pa.log_message_type;if(sa==p.SUBSCRIBE){aa(na,oa,pa.log_message_data.added_participants);}else if(sa==p.UNSUBSCRIBE){ba(na,oa,pa.log_message_data.removed_participants);}else if(sa==p.THREAD_IMAGE){if(!qa)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;}else if(sa==p.THREAD_NAME)oa.name=pa.log_message_data.name;break;case j.CHANGE_READ_STATUS:if(pa.timestamp)oa.last_read_timestamp=pa.timestamp;ha(na,oa,pa,pa.mark_as_read);break;case j.CLEAR_CHAT:ga(na,oa,pa.clear_time);break;case j.CHANGE_ARCHIVED_STATUS:oa.is_archived=pa.archived;break;case j.CHANGE_FOLDER:oa.folder=pa.new_folder;break;case j.DELETE_MESSAGES:if(qa){oa.snippet='...';oa.snippet_has_attachment=false;oa.snippet_attachments=null;oa.snippet_sender=null;oa.is_forwarded_snippet=false;na._threadInformer.updatedThread(pa.thread_id);}else if(pa.message_ids)oa.message_count=oa.message_count-pa.message_ids.length;break;case j.CHANGE_MUTE_SETTINGS:if(pa.mute_settings!==undefined){var ta=na._fbid+'@facebook.com';if(oa.mute_settings){if(pa.mute_settings){oa.mute_settings[ta]=pa.mute_settings;}else delete oa.mute_settings[ta];na._threadInformer.updatedThread(oa.thread_id);}}break;}if(!m.MercuryActionIDGK&&pa.action_id)oa.last_action_id=g.maxValidActionID(pa.action_id,oa.last_action_id);}function ja(na,oa){var pa=na._serverRequests.tokenizeThreadID(oa.thread_id),qa=la(na,oa.specific_to_list),ra={thread_id:oa.thread_id,last_action_id:null,participants:oa.specific_to_list,name:null,snippet:oa.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:oa.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:oa.timestamp_absolute,timestamp_relative:oa.timestamp_relative,timestamp:oa.timestamp,canonical_fbid:pa.type==='user'?pa.value:null,is_canonical_user:pa.type==='user',is_canonical:qa,is_subscribed:true,root_message_threading_id:oa.message_id,folder:s.INBOX,is_archived:false,mode:r.TITAN_ORIGINATED};if(!m.MercuryActionIDGK)ra.last_action_id=oa.action_id;return ra;}function ka(na){this._fbid=na;this._serverRequests=v.getForFBID(this._fbid);this._threadInformer=w.getForFBID(this._fbid);this._threads=new i();ma(this);}x(ka.prototype,{getThreadMetaNow:function(na){k.isThreadID(na);return this._threads.getResource(na);},getThreadMeta:function(na,oa,pa){var qa=function(ra){oa(ra[na]);};return this.getMultiThreadMeta([na],qa,pa);},getMultiThreadMeta:function(na,oa,pa){k.allThreadID(na);var qa=this._threads.executeOrEnqueue(na,oa),ra=this._threads.getUnavailableResources(qa);if(ra.length){var sa=[];for(var ta=0;ta<ra.length;ta++){var ua=ra[ta],va=this._serverRequests.tokenizeThreadID(ua);if(va.type=='user'){var wa=this.getCanonicalThreadToUser(va.value,null,pa,true);if(this.isEmptyLocalThread(wa.thread_id))sa.push(wa.thread_id);}else sa.push(ua);}if(sa.length)this._serverRequests.fetchThreadData(sa,pa);}return qa;},unsubscribe:function(na){this._threads.unsubscribe(na);},changeThreadReadStatus:function(na,oa){k.isThreadID(na);var pa=this._threads.getResource(na);if(ea(this,pa,oa))this._serverRequests.changeThreadReadStatus(na,oa,h.getFromMeta(pa));},changeThreadArchivedStatus:function(na,oa){k.isThreadID(na);var pa=this._threads.getResource(na);if(pa.is_archived!=oa){pa.is_archived=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadArchivedStatus(na,oa);}},markThreadSpam:function(na){this._serverRequests.markThreadSpam(na);},unmarkThreadSpam:function(na){this._serverRequests.unmarkThreadSpam(na);},updateThreadMuteSetting:function(na,oa){this._serverRequests.changeMutingOnThread(na,oa);},changeFolder:function(na,oa){k.isThreadID(na);var pa=this._threads.getResource(na);if(pa&&pa.folder!=oa){pa.folder=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadFolder(na,oa);}},deleteThread:function(na){k.isThreadID(na);this._serverRequests.deleteThread(na);},updateThreads:function(na){if(!na||!na.length)return;var oa={};na.forEach(function(pa){oa[pa.thread_id]=pa;});this._threads.addResourcesAndExecute(oa);},updateMetadataByActions:function(na,oa){if(!na||!na.length)return;var pa={},qa={},ra={};for(var sa=0;sa<na.length;sa++){var ta=na[sa];if(ta.is_forward)continue;var ua=ta.action_type,va=ta.thread_id;k.isThreadID(va);var wa=this.getThreadMetaNow(va);if(ua==j.LOG_MESSAGE&&ta.log_message_type==p.SERVER_ERROR)continue;var xa=!!(ta.sync_id||ta.action_id);if(!wa&&!xa&&ua==j.USER_GENERATED_MESSAGE){wa=ja(this,ta);this._threads.setResource(va,wa);}if(wa){if(ua==j.DELETE_THREAD){wa.message_count=0;this._threadInformer.deletedThread(va);continue;}if(ua==j.LOG_MESSAGE||ua==j.USER_GENERATED_MESSAGE)xa=!oa;if(wa.server_timestamp&&ta.timestamp<=wa.server_timestamp&&xa)continue;if(!ra[va])ra[va]=x({},wa);ia(this,ra[va],ta,oa);if(ua==j.USER_GENERATED_MESSAGE)pa[va]=ta;if(ua==j.USER_GENERATED_MESSAGE||ua==j.LOG_MESSAGE||ua==j.SEND_MESSAGE)if(ta&&ta.timestamp&&(!qa[va]||ta.timestamp>qa[va].timestamp))qa[va]=ta;}}for(var ya in ra){var za=ra[ya],ab=pa[ya];if(ab)da(za,ab);var bb=qa[ya],cb=za.timestamp;if(bb){if(bb.timestamp>cb)za=x(za,{timestamp_absolute:bb.timestamp_absolute,timestamp_relative:bb.timestamp_relative,timestamp:bb.timestamp});var db=za.server_timestamp;if(!oa&&bb.timestamp>db)za.server_timestamp=bb.timestamp;}this._threads.setResource(ya,za);}},getCanonicalThreadToUser:function(na,oa,pa,qa){return this.getCanonicalThreadToParticipant('fbid:'+na,oa,pa,qa);},getCanonicalThreadToParticipant:function(na,oa,pa,qa){var ra=this.getThreadIDForParticipant(na),sa=this._threads.getResource(ra);if(typeof sa=='undefined'){sa=this.createNewLocalThread(ra,[t.getIDForUser(this._fbid),na],oa);!qa&&this._serverRequests.fetchThreadData([ra],pa);}return sa;},getThreadIdForUser:function(na){return 'user:'+na;},getThreadIDForParticipant:function(na){var oa=o.tokenize(na);return this.getThreadIdForUser(oa.value);},createNewLocalThread:function(na,oa,pa){var qa=this._threads.getResource(na);if(!qa){var ra=this._serverRequests.tokenizeThreadID(na);qa={thread_id:na,last_action_id:null,participants:oa,name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:pa?pa:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:ra.type==='user'?ra.value:null,is_canonical_user:ra.type=='user',is_canonical:la(this,oa),is_subscribed:true,root_message_threading_id:null,folder:s.INBOX,is_archived:false,mode:r.TITAN_ORIGINATED};this._threads.setResource(na,qa);}return qa;},addParticipantsToThreadLocally:function(na,oa){var pa=this._threads.getResource(na);if(pa){aa(this,pa,oa);this._threadInformer.updatedThread(pa.thread_id);}},getCanonicalUserInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='user'?oa.value:null;},getCanonicalGroupInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='group'?oa.value:null;},isEmptyLocalThread:function(na){var oa=this._threads.getResource(na);if(!oa)return false;var pa=this._serverRequests.tokenizeThreadID(na);return pa.type=='root'&&!oa.timestamp;},isNewEmptyLocalThread:function(na){if(!this.isEmptyLocalThread(na))return false;var oa=this._threads.getResource(na);return oa.participants&&oa.participants.length===0;},canReply:function(na){var oa=this._threads.getResource(na),pa=m.ReadOnlyEmailThreads&&oa.has_email_participant;return oa&&oa.is_subscribed&&oa.mode!=r.OBJECT_ORIGINATED&&!pa&&!oa.read_only&&(oa.recipients_loadable||oa.recipients_loadable===undefined);}});x(ka,q);function la(na,oa){var pa=oa.filter(function(qa){return qa!=t.getIDForUser(na._fbid);});return pa.length<=1;}function ma(na){na._serverRequests.subscribe('update-threads',function(oa,pa){var qa=(pa.actions||[]).filter(function(ua){return ua.thread_id;});na.updateThreads(pa.threads);na.updateMetadataByActions(qa,pa.from_client);(pa.threads||[]).forEach(function(ua){na._threadInformer.updatedThread(ua.thread_id);});var ra=pa.global_actions||[];for(var sa=0;sa<ra.length;sa++){var ta=ra[sa];if(ta.action_type==n.MARK_ALL_READ)fa(na,ta.folder);}});}u.registerCallback('mercury-threads',function(){var na={};na.threads={};var oa=ka._getInstances();for(var pa in oa)na.threads[pa]=oa[pa]._threads.dumpResources();return na;});e.exports=ka;},null);
__d("MercuryUnreadState",["MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionTypeConstants","MercuryConfig","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MessagingTag","ReportState","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){var w=(g.getSupportedFolders()||[]).filter(function(pa){return pa!=o.ACTION_ARCHIVED;}),x='unread_thread_hash',y='unseen_thread_list',z=n.MAX_UNREAD_COUNT,aa=h.getInstance('mercury_unread_state');function ba(pa){this._fbid=pa;this._serverRequests=q.getForFBID(this._fbid);this._threadInformer=r.getForFBID(this._fbid);this._threads=s.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};w.forEach(function(qa){this._initialUnreadCount[qa]=0;this._maxCount[qa]=false;this._unreadResources[qa]=new i();}.bind(this));this._serverRequests.subscribe('update-unread',function(qa,ra){ga(this,ra);var sa=ra.global_actions||[];for(var ta=0;ta<sa.length;ta++){var ua=sa[ta];if(ua.action_type==l.MARK_ALL_READ)la(this,ua.folder,ua.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(qa,ra){na(this,ra);}.bind(this));}u(ba.prototype,{getUnreadCount:function(pa){if(this.exceedsMaxCount(pa)){aa.error('unguarded_unread_count_fetch',{});return 0;}return fa(this,pa);},exceedsMaxCount:function(pa){return this._maxCount[pa]||(fa(this,pa)>z);},markFolderAsRead:function(pa){if(this._maxCount[pa]||fa(this,pa)>0)this._serverRequests.markFolderAsRead(pa);}});u(ba,m);function ca(pa,qa,ra){pa._unreadResources[qa].setResource(x,ra);pa._unreadResources[qa].setResource(y,Object.keys(ra));}function da(pa,qa,ra){var sa=pa._unreadResources[qa].executeOrEnqueue(x,ra),ta=pa._unreadResources[qa].getUnavailableResources(sa);if(ta.length)pa._serverRequests.fetchUnreadThreadIDs(qa);}function ea(pa,qa){return pa._unreadResources[qa].getResource(x);}function fa(pa,qa){var ra=pa._unreadResources[qa].getResource(y);if(ra){return ra.length;}else return pa._initialUnreadCount[qa];}function ga(pa,qa){if(k.MercuryFBIDGK){ia(pa,qa);}else ha(pa,qa);}function ha(pa,qa){var ra;(qa.unread_thread_ids||[]).forEach(function(sa){ra=sa.folder;if(!oa(ra))return;var ta=ma(pa,sa.thread_ids);ca(pa,ra,v(ta,true));if(ta.length>z)pa._maxCount[ra]=true;pa._threadInformer.updatedUnreadState();});(qa.message_counts||[]).forEach(function(sa){if(sa.unread_count===undefined)return;ra=sa.folder;if(sa.unread_count>z){pa._maxCount[ra]=true;ca(pa,ra,{});pa._threadInformer.updatedUnreadState();}else{pa._initialUnreadCount[ra]=sa.unread_count;if(pa._initialUnreadCount[ra]===0)ca(pa,ra,{});pa._threadInformer.updatedUnreadState();}});(qa.actions||[]).forEach(function(sa){if(sa.is_forward)return;var ta=j,ua=sa.thread_id?sa.thread_id:sa.server_thread_id;if(sa.action_type==ta.DELETE_THREAD){w.forEach(function(wa){ka(pa,wa,ua);});}else if(sa.action_type==ta.CHANGE_ARCHIVED_STATUS||sa.action_type==ta.CHANGE_FOLDER){var va=pa._threads.getThreadMetaNow(sa.thread_id);ra=g.getFromMeta(va);if(oa(ra)&&va.unread_count>0)ja(pa,ra,ua);w.forEach(function(wa){if(wa!=ra)ka(pa,wa,ua);});}else{ra=sa.folder;if(!oa(ra))return;if(sa.action_type==ta.CHANGE_READ_STATUS){if(sa.mark_as_read){ka(pa,ra,ua,sa.timestamp);}else ja(pa,ra,ua,sa.timestamp);}else if(sa.action_type==ta.USER_GENERATED_MESSAGE||sa.action_type==ta.LOG_MESSAGE)if(sa.is_unread)ja(pa,ra,ua,sa.timestamp);}});}function ia(pa,qa){var ra;(qa.unread_thread_fbids||[]).forEach(function(sa){ra=sa.folder;if(!oa(ra))return;var ta=sa.thread_fbids||[];ta=ta.concat(sa.other_user_fbids||[]);var ua=ma(pa,ta);ca(pa,ra,v(ua,true));if(ua.length>z)pa._maxCount[ra]=true;pa._threadInformer.updatedUnreadState();});(qa.message_counts||[]).forEach(function(sa){if(sa.unread_count===undefined)return;ra=sa.folder;if(sa.unread_count>z){pa._maxCount[ra]=true;ca(pa,ra,{});pa._threadInformer.updatedUnreadState();}else{pa._initialUnreadCount[ra]=sa.unread_count;if(pa._initialUnreadCount[ra]===0)ca(pa,ra,{});pa._threadInformer.updatedUnreadState();}});(qa.actions||[]).forEach(function(sa){if(sa.is_forward)return;var ta=j,ua=sa.other_user_fbid?sa.other_user_fbid:sa.thread_fbid,va=sa.thread_id?sa.thread_id:ua;if(sa.action_type==ta.DELETE_THREAD){w.forEach(function(xa){ka(pa,xa,va);});}else if(sa.action_type==ta.CHANGE_ARCHIVED_STATUS||sa.action_type==ta.CHANGE_FOLDER){var wa=pa._threads.getThreadMetaNow(sa.thread_id);ra=g.getFromMeta(wa);if(oa(ra)&&wa.unread_count>0)ja(pa,ra,va);w.forEach(function(xa){if(xa!=ra)ka(pa,xa,va);});}else{ra=sa.folder;if(!oa(ra))return;if(sa.action_type==ta.CHANGE_READ_STATUS){if(sa.mark_as_read){ka(pa,ra,va,sa.timestamp);}else ja(pa,ra,va,sa.timestamp);}else if(sa.action_type==ta.USER_GENERATED_MESSAGE||sa.action_type==ta.LOG_MESSAGE)if(sa.is_unread)ja(pa,ra,va,sa.timestamp);}});}function ja(pa,qa,ra,sa){if(pa._maxCount[qa])return;da(pa,qa,function(ta){var ua=pa._allReadTimestamp[qa]||0,va=pa._threadReadTimestamp[ra]||0,wa=sa||Number.POSITIVE_INFINITY;if(wa>=ua&&wa>=va&&!ta[ra]){ta[ra]=sa||0;ca(pa,qa,ta);pa._threadInformer.updatedUnreadState();}});}function ka(pa,qa,ra,sa){if(pa._maxCount[qa])return;da(pa,qa,function(ta){if(sa){var ua=pa._threadReadTimestamp[ra];if(!ua||ua<sa)pa._threadReadTimestamp[ra]=sa;}var va=ta[ra];if(sa&&typeof va=='number'&&sa<va)return;if(ra in ta){delete ta[ra];ca(pa,qa,ta);pa._threadInformer.updatedUnreadState();}});}function la(pa,qa,ra){pa._maxCount[qa]=false;ca(pa,qa,{});pa._allReadTimestamp[qa]=Math.max(pa._allReadTimestamp[qa]||0,ra||0);pa._threadInformer.updatedUnreadState();}function ma(pa,qa){return qa.map(pa._serverRequests.convertThreadIDIfAvailable,pa._serverRequests);}function na(pa,qa){w.forEach(function(ra){var sa=ea(pa,ra);if(!sa)return;for(var ta in qa){var ua=qa[ta];if(sa[ta]){sa[ua]=sa[ta];delete sa[ta];}}ca(pa,ra,sa);});}function oa(pa){return t(w,pa);}p.registerCallback('mercury-unread-state',function(){var pa={};pa.unread={};pa.unread_max_count={};var qa=ba._getInstances();for(var ra in qa){pa.unread[ra]={};pa.unread_max_count[ra]={};w.forEach(function(sa){pa.unread[ra][sa]=u({},ea(qa[ra],sa));pa.unread_max_count[ra][sa]=qa[ra]._maxCount[sa];});}return pa;});e.exports=ba;},null);
__d("MercuryFilters",["MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h){var i=[g.UNREAD],j={ALL:'all',getSupportedFilters:function(){return i.concat();},isSupportedFilter:function(k){return h(i,k);}};e.exports=j;},null);